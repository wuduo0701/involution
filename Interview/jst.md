Situation（背景）：做这个项目的背景是什么，比如这是个人项目还是团队项目，为什么需要做这个
项目，你的角色是什么，等等。
Target（目标）：该项目要达成的目标是什么？为了完成这个目标有哪些困难？
Action（行动）：针对所要完成目标，你做了哪些工作？如何克服了其中一些困难？
Result（结果）：项目最终结果如何？有哪些成就？有哪些不足之处可以改进？

# 京数通

项目名称：京数通
技术栈：Vue3 + TypeScript + Vite + Less + Antdv + Qiankun + Vitest
项目描述：

- 京数通是一款广告数据分析运营平台，通过对零售海量广告业务数据的加工和呈现，为用户提供各种详细指标维度的数据分析、数据监控等服务，是一站式 Saas 化的数据可视化系统
- 设计以 Qiankun 作为微前端框架并开发京数通为主应用，期间共有三个组内系统接入以及多个外部门系统接入子应用。
- 个人主要负责中国式日报、数据订阅、自定义看板、智能预警、智能问答等业务模块开发

## 项目介绍

是一款具有广告特色的数据分析运营平台，可以为用户提供各种详细的维度（产品线、事业群）指标（展点消、财收）的数据报表能力。
主要面向全体广告的运营、销售、分析师等用户。
底层对接着一个元数据平台。通过连接元数据平台能自由化配置出各种各样的报表，然后基于这个报表分析能力去做一些更多的看板、日报、订阅能力，预警等能力建设。
我主要负责该项目的日常及大促需求迭代，包括支持微前端架构改造、中国式日报、日报截图等需求。

<!-- 通过对零售海量广告业务数据的加工和呈现，为用户提供各种详细的维度（产品线、事业群）指标（展点消、财收）的数据报表和趋势图分析能力、智能预警能力等（这块比较抽象，我大概描述下因为广告分了很多站外媒体，广告的类型（站内、还是站外），以及在哪投的广告），然后能看到对应广告的效果（展点消、财收）等。
我主要负责该项目的日常及大促需求迭代，包括支持微前端架构改造、中国式日报、日报截图等需求。 -->

其中在做这个项目中遇到的最大困难时是微前端架构改造这个需求
因为子应用默认只会加载一个，如果加载另一个就会把之前的卸载了。而京数通是存在多页标签的系统，如果单页面利用 keep-alive 就行。但是切换会导致应用卸载，这样就会导致所有缓存失效了。

中国式日报：

1. 表头结构复杂，信息量大
2. 可以自由配置列维度、行维度。有总结、小计
3. 支持指标计算，同比、环比、近 7 天、30 天等
4. 动态日期
5. 表格组合
<!-- 该需求背景是最开始做京数通 2.0 系统重构的时候，因为在最开始 1.0，实时看板是基于 iframe 的方式接入的。而当时基于老项目技术的限制，没有做微前端改造。而后在重构重提了这次需求，我是本次需求的负责人。 -->

<!-- 而后我主要调研了公司内部以及外部成熟的微前端框架，最终选定了 qiankun。 -->

<!-- 该项目主要的功能模块：自定义报表（能通过底层平台提供的能力（源数据平台），每个报表对应一个数据源和多个维度指标等自定义配置化报表），自定义看板（通过报表的权限及其指标，用户能够自定义配置看板数据。）、中国式日报（复杂报表，支持多个数据源混用配置日报。并且支持固定化的分维度看数，并支持数据订阅日报）等功能。 -->

## 重难点

在微前端改造的时候，我主要碰到最大的难题是：

1. 两个子应用之间相互切换数据缓存问题

   - 问题：
     如果是同一个应用中。以 vue 举例，常用的解决方案就是用 v-show（它本质是通过 display:none 来解决的）；如果是组件缓存，则是用 keep-alive 组件进行缓存。
     但是对于两个子应用来说：缓存被没有生效，每次切换两个子应用都会加载子应用和渲染子应用。并且之前用过 keep-alive 缓存的话，缓存也会失效。

   - 两个解决方案：
     1. 在主应用中用不同的 dom 控制不同的子应用渲染，然后通过
        `<div id="appContainer1" v-show="$route.path.startsWith('/app-vue-hash/')"></div>`
        控制子应用 dom 显示哪一个子应用
        初始化时通过 loadMicroApp 手动控制加载哪个子应用
        路由切换时则由 v-show 控制
        - 优点
          - 实现简单，v-show 来满足
          - 不需要卸载子应用，页签切换速度比较快
        - 缺点
          - 只能控制自己系统的改造
          - 子应用切换时不销毁 DOM，会导致 DOM 节点和事件监听过多，严重时会造成页面卡顿
          - 多个子应用之间，css 会冲突
     2. registerMicroApps 注册所有子应用，然后 start 开启预加载，并且开启 singular 多实例模式。通过 patch-package 的方式来修改 qiankun 源码的 loader.js 这个文件。修改子项目的 render()和 unmount()方法
     子应用切换的时候会触发各自子应用的生命周期
     即增加判断如果 `!getContainer(initialContainer).firstChild` 的实例不存在，才执行生命周期。
     否则跳过。
     <!-- https://developer.aliyun.com/article/1304098?spm=a2c6h.14164896.0.0.470f47c5nvJQSO&scm=20140722.S_community@@%E6%96%87%E7%AB%A0@@1304098._.ID_1304098-RL_%E5%BE%AE%E5%89%8D%E7%AB%AF%E9%A1%B9%E7%9B%AE%E9%9A%BE%E7%82%B9%E8%A7%A3%E5%86%B3-LOC_search~UND~community~UND~item-OR_ser-V_3-P0_0 -->

2.

## 带来的问题

1. 子应用需要设置跨域，会带来浏览器安全问题
2. 老项目的资源加载问题
   1. 利用 webpack 的 loader，重写路径
   2. 转化成 base64
3. start 函数
   1. prefetch
   2. sandbox 沙箱模式
   3. singular
   4. fetch
4. 沙箱不能解决的 js 污染问题？
   1. 代码规范问题
   2. 手动在卸载后清除
5. 在什么情况下，你会选择使用 iframe 而不是 qiankun
   1. 介绍下 iframe 的问题，已经用 qiankun 的好处
   2. 根据具体的使用场景来定。
      1. 如果是是基于现代前端框架的子应用，那么 qiankun 更合适
      2. 如果子应用是一个很老技术的页面或者第三方的页面，那么使用 iframe 更好一点，能做到更好的硬隔离
   3.
