## 浏览器缓存

![alt text](/assets/images/broswer/image.png)

### 缓存过程

> 浏览器每次发起请求，都会先在浏览器缓存中查找该请求的结果以及缓存标识
> 浏览器会根据 HTTP 头的缓存标识，每次拿到返回的结果都会将该结果和缓存标识存入浏览器缓存中

### 强缓存

> 强缓存就是向浏览器缓存查找缓存的请求结果，并根据缓存的标识判断该缓存是否能够被使用。共分以下三种情况：

- 不存在强缓存和缓存标识，强制缓存失效，则直接向服务器发起请求
- 存在强缓存，但是缓存标识已失效。则强缓存失效，去使用协商缓存
- 存在强缓存和缓存标识，且该结果尚未失效，强制缓存生效

#### 缓存规则

> 强缓存共分两个字段（Expires 和 Cache-Control），其中 Cache-Control 优先级比 Expires 高  
> 缓存字段会放在 HTTP 请求头和结果中，一起返回给浏览器

- Expires
  > HTTP1.0 控制缓存的字段，值为控制缓存的到期时间点（绝对时间）。即在此发起请求时，如果客户端时间 < Expires 时间，则使用缓存
  - 弊端
    Expires 是精确到具体每个时间点过期，但是如果因为一些原因客户端(浏览器)时间发生误差变化，那么强缓存会存在误失效
- Cache-Control
  > HTTP1.1 控制缓存的字段，为缓存的时间范围（相对时间）
  > date + max-age < now(客户端当前时间)
  - 取值
    - public 所有内容都可缓存 -> 服务器和客户端
    - private 所有内容都可以缓存 -> 客户端
    - no-cache 不使用强缓存，需要与协商缓存一起验证
    - no-store 不使用缓存，包括强缓存和协商缓存
    - max-age 数字，缓存的时间在多少 s 失效（服务器返回资源的时候会携带获取当前资源的时间+最大缓存时间，这样请求就会每次计算当前时间有没有超过 max-age）

#### 缓存位置

- 内存缓存（memory cache）
  存放在电脑的`内存`中，会占据进程的一些内存资源，具备快速读取和时效性（进程关闭，缓存就失效）
- 硬盘缓存（disk cache）
  存放在电脑的`硬盘`中，具有 IO 操作，需要重新解析和读取，速度较慢

### 协商缓存

> 协商缓存就是强制缓存失效后，浏览器携带缓存标识(Last-Modified / If-Modified-Since 和 Etag / If-None-Match)向服务器发起请求，由服务器根据缓存标识决定是否使用缓存的过程。其中 Etag / If-None-Match 的优先级比 Last-Modified / If-Modified-Since 高。

- 协商缓存流程
  浏览器发起请求 -> 去浏览器缓存中（强缓存）判断缓存已失效 -> 携带`协商缓存标识`返回给浏览器 -> 浏览器携带`协商缓存标识`发起 HTTP 请求 -> 服务器拿到`协商缓存标识`判断资源是否更新 -> 缓存更新，重新返回结果（HTTP 状态码为 200） / 缓存未更新，浏览器不返回，还是重新从浏览器缓存取(HTTP 状态码为 304)

#### 缓存规则

- `Last-Modified`/ `If-Modified-Since`
  > 客户端资源与服务器资源的时间对比
  - `Last-Modified`（服务器上的，资源在服务器上最后修改的时间）
  - `If-Modified-Since`（客户端请求携带的，这个字段是上次请求服务器返回给客户端的，代表上次资源的请求时间）
    无强缓存时，浏览器会携带一个 `If-Modified-Since` 请求头字段（客户端携带的，这个字段是上次请求服务器返回给客户端的，代表上次资源的请求时间）。服务器收到请求后，会拿 `If-Modified-Since` 字段与`Last-Modified`（资源在服务器上最后修改的时间）进行比对。如果服务器时间大于了`If-Modified-Since`字段，则代表资源更新了，则重新请求资源。
- `Etag` / `If-None-Match`
  > 客户端资源与服务器资源文件的唯一标识对比
  - `Etag`（服务器上的，代表服务器资源的唯一标识）
  - `If-None-Match`（客户端请求携带，代表上次请求服务器返回的唯一标识（Etag）字段，代表上次资源的唯一标识）
    触发顺序和上述步骤一致，把服务器修改替换成唯一标识

Etag / If-None-Match 优先级高于 Last-Modified / If-Modified-Since。

![alt text](/assets/images/broswer/image1.png)
